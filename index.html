<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema DITL — Agenda & Execução</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    
    <div class="main-layout">
        
        <div class="sidebar">
            
            <div class="sidebar-title">
                <div id="logoArea">
                    <img src="image/Logo.png" alt="Logo da Empresa">
                </div>
                <h1>Sistema DITL</h1>
                <div class="small">Agenda & Execução</div>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('cadastro', this)">Cadastro / Import</button>
                <button class="tab-btn" onclick="showTab('execucao', this)">Execução</button>
                <button class="tab-btn" onclick="showTab('relatorios', this)">Relatórios</button>
            </div>
            
        </div>
        
        <div class="content-area">
            
            <div class="top-header">
                
                <div class="turn-controls">
                    <button id="btnStartShift" onclick="startShift()" disabled>Iniciar Turno</button>
                    <button id="btnEndShift" onclick="endShift()">Encerrar Turno</button>
                    <div id="shiftStatus" class="small">Turno encerrado ou não iniciado.</div>
                </div>

                <div id="notificationIconContainer" onclick="toggleNotificationPanel()">
                    <i class="bi bi-bell-fill"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </div>
            </div>

            <div id="cadastro" class="tab-content active">
                <div class="card">
                    <h2>Importar planilha (DITL)</h2>
                    
                    <div class="form-group">
                        <label>Importar arquivo (.xlsx ou .csv)</label>
                        <input type="file" id="fileUpload" accept=".csv,.xlsx,.xls" onchange="onFileSelected(event)">
                        <div class="small mt-8" style="color:#F27EBE;">
                            Colunas esperadas: <strong>T + (hh:mm)</strong>, <strong>Proc. ID</strong>, <strong>Event</strong>, <strong>Event / Action</strong>, <strong>Key Acceptance Criteria</strong>.
                        </div>
                    </div>

                    <div class="btn-group mt-8">
                        <button onclick="clearAllData()">Limpar dados</button>
                    </div>
                </div>

                <div id="loadedContainer" class="card hidden">
                    <h2>Atividades carregadas</h2>
                    
                    <div class="form-group mb-10">
                        <input type="text" id="searchActivitiesInput" onkeyup="filterActivities()" placeholder="Filtrar atividades por nome ou ID..." style="width: 100%;">
                    </div>
                    
                    <div id="loadedSummary" class="mb-8"></div>
                    <div id="taskPreview" class="task-list"></div>
                </div>
            </div>

            <div id="execucao" class="tab-content">
                
                <div class="execution-summary-grid">
                    
                    <div class="execution-stats-container">
                        <div class="card">
                            <div class="small">Atividades</div>
                            <div id="totalActivities"></div>
                        </div>
                        <div class="card">
                            <div class="small">Instâncias ativas</div>
                            <div id="activeActivities"></div>
                        </div>
                    </div>
                    
                    <div class="export-card">
                        <h2 class="mb-10" style="font-size: 1.2rem;">Exportação de Dados (Backup)</h2>
                        <div class="btn-group">
                            <button class="btn-small" onclick="downloadJSON()">Exportar JSON</button>
                            <button class="btn-small" onclick="downloadAllImagesZip()">Baixar imagens (ZIP)</button>	
                        </div>
                    </div>
                    
                </div>

                <div class="card">
                    <h2>Selecionar atividade / instância</h2>
                    <div id="activityList"></div>
                </div>

                <div id="executionPanel" class="card hidden">
                    <h2 id="executionTitle"></h2>
                    <div class="progress-bar"><div class="progress-fill" id="progressBar">0%</div></div>

                    <div class="form-group mb-15">
                        <label for="executionFilter" style="margin-bottom: 5px;">Filtrar Tarefas por Status</label>
                        <select id="executionFilter" onchange="renderExecutionTasks()">
                            <option value="todos">Todas as Tarefas</option>
                            <option value="nao iniciada">Não Iniciadas</option>
                            <option value="em execucao">Em Execução</option>
                            <option value="pausada">Pausadas</option>
                            <option value="concluida">Finalizadas</option>
                        </select>
                    </div>
                    <div id="executionTasks"></div>
                </div>
            </div>
            <div id="relatorios" class="tab-content">
                <div class="card">
                    <h2>Relatórios</h2>
                    
                    <div class="form-group mb-15">
                        <label for="reportFilter" style="margin-bottom: 5px;">Filtrar por Status</label>
                        <select id="reportFilter" onchange="renderAllReports()">
                            <option value="todos">Todos</option>
                            <option value="ativo">Ativo</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>

                    <div class="btn-group mb-12">
                        <button onclick="generateFinalReportPDF()">Relatório Final (Tudo)</button>
                    </div>
                    <div id="reportList"></div>
                </div>
            </div>
            
        </div>
        
    </div>
    
    <div class="notification-panel" id="notificationPanel">
        <div class="mb-15" style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="color:#F27EBE;">Notificações</h3>
            <button class="btn-secondary btn-small" onclick="toggleNotificationPanel()">Fechar</button>
        </div>
        <button class="btn-secondary btn-small" onclick="clearNotificationLog()">Limpar</button>
        <div id="notificationLog" class="mt-15"> 
            <div class="small" style="opacity: 0.7;">Nenhum alerta recente.</div>
        </div>
    </div>
    
    <div id="confirmClearDataModal" class="hidden" aria-hidden="true">
        <div class="modal-card">
            <h3>ATENÇÃO: Limpeza de Dados!</h3>
            <p class="mb-15">Tem certeza que deseja apagar **TODOS** os dados armazenados localmente (atividades, execuções e logs)? Esta ação não pode ser desfeita.</p>
            
            <div class="btn-group">
                <button class="button btn-secondary" onclick="closeClearDataConfirmation()">Não, Cancelar</button>
                <button class="button" style="background:#f44336;" onclick="confirmClearAllData()">Sim, Apagar Tudo</button>
            </div>
        </div>
    </div>


    <div id="confirmEndShiftModal" class="hidden" aria-hidden="true">
        <div class="modal-card">
            <h3>ATENÇÃO: Tarefas pendentes!</h3>
            <p id="pendingTaskMessage" class="mb-15">Ainda há tarefas não concluídas. Deseja encerrar o turno e gerar o relatório mesmo assim?</p>
            
            <div class="btn-group">
                <button class="button btn-secondary" onclick="closeEndShiftConfirmation()">Não, continuar trabalho</button>
                <button class="button" style="background:#f44336;" onclick="confirmEndShift(true)">Sim, encerrar agora</button>
            </div>
        </div>
    </div>

    <div id="startTaskModal" class="hidden" aria-hidden="true">
        <div class="modal-card">
            <h3>Iniciar tarefa</h3>
            <p id="taskNameDisplay"></p>

            <div class="form-group">
                <label for="modalOperatorIdInput">ID do operador</label>
                <input type="text" id="modalOperatorIdInput" placeholder="Ex: Lola" required>
            </div>

            <div class="form-group">
                <label for="timeModeSelect">Modo de cronometragem</label>
                <select id="timeModeSelect" onchange="updateTimeModeDisplay()">
                    <option value="manual">Manual (Cronômetro normal)</option>
                    <option value="countdown">Contagem regressiva (Duração HH:MM)</option>
                    <option value="scheduled">Horário programado (Janela de tempo)</option>
                </select>
            </div>

            <div class="form-group hidden" id="countdownTimeGroup">
                <label for="countdownTimeInput">Duração máxima (hh:mm)</label>
                <input type="time" id="countdownTimeInput" value="00:10" step="60" required>
            </div>

            <div class="form-group hidden" id="scheduledTimeGroup">
                <div id="scheduledTimeInputs">
                    <div>
                        <label for="scheduledAlertTimeInput">Hora de início do alerta (hh:mm)</label>
                        <input type="time" id="scheduledAlertTimeInput" value="12:30" step="60" required>
                    </div>
                    <div>
                        <label for="scheduledLimitTimeInput">Hora limite (hh:mm)</label>
                        <input type="time" id="scheduledLimitTimeInput" value="13:30" step="60" required>
                    </div>
                </div>
                <div class="small mt-8" style="opacity: 0.8;">O alerta será disparado no 1º horário. O timer irá contar até o 2º horário.</div>
            </div>
            
            <div class="btn-group" style="justify-content: flex-end;">
                <button class="button btn-secondary" onclick="closeTaskStartModal()">Cancelar</button>
                <button class="button" style="background:#4CAF50;" id="confirmStartTaskButton" onclick="confirmTaskStart()">Confirmar e iniciar</button>
            </div>
        </div>
    </div>

    <div id="evidenceModal" class="hidden" aria-hidden="true">
        <div class="modal-card">
            <h3>Evidências da atividade</h3>
            <p id="evidenceModalTaskName" class="mb-15 fw-700" style="color: #F27EBE;"></p>

            <div class="form-group">
                <label for="evidenceModalObservation">Observação da tarefa (Obrigatório)</label>
                <textarea id="evidenceModalObservation" placeholder="Descreva o que foi feito ou o motivo da falha." required></textarea>
            </div>

            <div class="form-group">
                <label>Fotos de evidência (Máximo 3)</label>
                <div id="evidencePhotoPreview" class="mb-8" style="display:flex; flex-wrap:wrap; gap:8px;">
                    </div>
                <input type="file" id="evidenceFileInput" accept="image/*" multiple class="hidden">
                <button class="btn-secondary mt-8" onclick="document.getElementById('evidenceFileInput').click()">Adicionar foto</button>
            </div>

            <div class="btn-group" style="justify-content: flex-end;">
                <button class="button btn-secondary" onclick="closeEvidenceModal()">Cancelar</button>
                <button class="button" id="evidenceSubmitButton" style="background:#F20587;" onclick="submitEvidenceAndComplete()">Confirmar e finalizar</button>
            </div>
        </div>
    </div>

    <div id="mappingModal" class="hidden" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mapTitle" style="max-width: 980px;">
            <h3 id="mapTitle">Preview & Mapeamento de colunas</h3>
            <p class="small mb-8">Confirme o mapeamento das colunas detectadas e verifique as primeiras linhas antes de importar.</p>

            <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
                <div style="flex:1"><label>T + (hh:mm)</label><select id="mapTime"></select></div>
                <div style="flex:1"><label>Proc. ID</label><select id="mapProc"></select></div>
                <div style="flex:1"><label>Event</label><select id="mapEvent"></select></div>
                <div style="flex:1"><label>Event / Action</label><select id="mapAction"></select></div>
                <div style="flex:1"><label>Key Acceptance Criteria</label><select id="mapAcceptance"></select></div>
            </div>

            <div id="mappingPreview" class="p-12" style="background: #fff; color: #000; border-radius: 8px; overflow: auto; max-height: 320px;"></div>

            <div class="btn-group mt-8" style="justify-content:flex-end">
                <button onclick="confirmImport()" style="background:#4CAF50">Confirmar importação</button>
                <button onclick="cancelMapping()" style="background:#f44336">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="reportPreviewModal" class="hidden">
        <div class="report-card" id="reportPreviewContent" style="max-width: 900px;">
            <div class="btn-group mb-8" style="justify-content:flex-end">
                <button onclick="downloadReportPDFFromPreview()">Baixar PDF</button>
                <button onclick="closeReportPreview()">Fechar</button>
            </div>
            <div id="reportPreviewInner"></div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>